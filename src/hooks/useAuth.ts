/**
 * ==================== HOOK DE AUTENTICA√á√ÉO (useAuth) ====================
 * 
 * DESCRI√á√ÉO:
 * Hook customizado para gerenciar autentica√ß√£o de usu√°rios
 * Centraliza toda l√≥gica de login, registro, logout e persist√™ncia
 * 
 * ESTADOS GERENCIADOS:
 * - user: Dados do usu√°rio logado (null se n√£o autenticado)
 * - loading: Estado de carregamento da verifica√ß√£o de autentica√ß√£o
 * 
 * FUN√á√ïES EXPOSTAS:
 * - login(cpf, password, userType): Autentica usu√°rio
 * - register(userData): Registra novo usu√°rio
 * - logout(): Desautentica e limpa todos os dados
 * - getAuthToken(): Retorna token JWT armazenado
 * 
 * PERSIST√äNCIA:
 * - Dados do usu√°rio salvos em localStorage ('currentUser')
 * - Token JWT salvo em localStorage ('authToken')
 * - Limpeza completa de dados ao fazer logout
 * 
 * BACKEND ENDPOINTS:
 * - POST /login: Autentica usu√°rio
 * - POST /register: Registra novo usu√°rio
 */

import { useState, useEffect } from "react";
import { useToast } from "@/hooks/use-toast";
import { useNavigate } from "react-router-dom";
import { apiFetch } from "@/lib/api";

interface User {
  uid: string;
  email: string;
  nomeCompleto: string;
  userType: 'aluno' | 'professor';
  cpf: string;
  score?: number;
  rank?: string;
}

export const useAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();
  const navigate = useNavigate();

  /**
   * FUN√á√ÉO: Limpar formata√ß√£o do CPF
   * Remove pontos e h√≠fen do CPF, retornando apenas d√≠gitos
   * @param cpf - CPF com ou sem formata√ß√£o
   * @returns CPF com apenas d√≠gitos
   */
  const cleanCpf = (cpf: string): string => {
    return cpf.replace(/[\.\-]/g, '');
  };

  /**
   * EFEITO: Inicializa√ß√£o - Verificar sess√£o existente
   */
  useEffect(() => {
    console.log('üîê [useAuth] Inicializando hook de autentica√ß√£o...');
    
    // Verificar se h√° usu√°rio salvo no localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      try {
        const userData = JSON.parse(savedUser);
        console.log('‚úÖ [useAuth] Sess√£o existente encontrada:', {
          uid: userData.uid,
          nome: userData.nomeCompleto,
          tipo: userData.userType
        });
        setUser(userData);
      } catch (error) {
        console.error('‚ùå [useAuth] Erro ao carregar usu√°rio salvo:', error);
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userEmail');
      }
    } else {
      console.log('‚ÑπÔ∏è [useAuth] Nenhuma sess√£o existente encontrada');
    }
    setLoading(false);
  }, []);

 /**
   * FUN√á√ÉO: Login de usu√°rio
   * 
   * PAR√ÇMETROS:
   * @param cpf - CPF sem formata√ß√£o (apenas n√∫meros, 11 d√≠gitos)
   * @param password - Senha do usu√°rio
   * @param userType - Tipo de usu√°rio ('aluno' | 'professor')
   * 
   * FLUXO:
   * 1. Valida CPF (11 d√≠gitos)
   * 2. Envia requisi√ß√£o POST para /api/login com { cpf, password, userType }
   * 3. Se sucesso:
   *    - Salva dados do usu√°rio e email no localStorage
   *    - Salva token JWT no localStorage
   *    - Atualiza estado local com dados do usu√°rio
   *    - Redireciona para /student ou /professor
   *    - Exibe toast de sucesso
   * 4. Se erro:
   *    - Exibe toast com mensagem de erro
   *    - Retorna objeto com success: false
   * 
   * RETORNO:
   * { success: boolean, error?: string }
   */

  const login = async (cpf: string, password: string, userType: 'aluno' | 'professor') => {
    console.log('üîê [useAuth] Tentando fazer login...', { cpf, userType });

    const cleanedCpf = cleanCpf(cpf);
    if (!cleanedCpf || !/^\d{11}$/.test(cleanedCpf)) {
      console.error('‚ùå [useAuth] CPF inv√°lido:', cpf);
      toast({
        title: "Erro no login",
        description: "O CPF deve conter 11 d√≠gitos num√©ricos (ex.: 12345678901).",
        variant: "destructive",
      });
      return { success: false, error: 'Invalid CPF format' };
    }

    if(!password || !userType) {
      console.error('‚ùå [useAuth] Campos obrigat√≥rios faltando:', { password: !!password, userType: !!userType });
      toast({
        title: "Erro no login",
        description: "Por favor, preencha todos os campos.",
        variant: "destructive",
      });
      return { success: false, error: 'Missing password or userType' };
    }
    
    try {
      const response = await apiFetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cpf, password, userType })
      });

      console.log('üì° [useAuth] Resposta do servidor:', response.status);
      
      // Verificar se a resposta √© JSON
      const contentType = response.headers.get('content-type');
      console.log('üìã [useAuth] Content-Type da resposta:', contentType);
      
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('‚ùå [useAuth] API retornou HTML ao inv√©s de JSON:', text.substring(0, 200));
        throw new Error('Erro de comunica√ß√£o com o servidor. A API n√£o est√° respondendo corretamente.');
      }

      if (!response.ok) {
        const errorData = await response.json();
        console.error('‚ùå [useAuth] Erro na resposta:', errorData);
        throw new Error(errorData.error || 'Erro no login');
      }

      const data = await response.json();
      const userData = {
        uid: data.userId,
        email: data.email || localStorage.getItem('userEmail'),
        nomeCompleto: data.nomeCompleto,
        userType: data.userType,
        cpf
      };
      
      console.log('‚úÖ [useAuth] Login bem-sucedido!', {
        uid: userData.uid,
        nome: userData.nomeCompleto,
        tipo: userData.userType
      });
      
      // Salvar no localStorage
      localStorage.setItem('currentUser', JSON.stringify(userData));
      localStorage.setItem('authToken', data.token);
      localStorage.setItem('userEmail', userData.email);
      console.log('üíæ [useAuth] Dados salvos no localStorage');
      
      setUser(userData);
      
      toast({
        title: "Login realizado com sucesso!",
        description: `Bem-vindo, ${userData.nomeCompleto}`,
      });

      navigate(userType === 'aluno' ? '/student' : '/professor');
      return { success: true };
    } catch (error: any) {
      console.error('‚ùå [useAuth] Erro no login:', error.message);
      toast({
        title: "Erro no login",
        description: error.message || "Erro ao tentar fazer login",
        variant: "destructive",
      });
      return { success: false, error: error.message };
    }
  };

  /**
   * FUN√á√ÉO: Registro de novo usu√°rio
   * 
   * PAR√ÇMETROS:
   * @param userData - Objeto com dados do novo usu√°rio
   *   { userType, nomeCompleto, cpf, password, genero, dataNascimento }
   * 
   * FLUXO:
   * 1. Envia requisi√ß√£o POST para backend /register
   * 2. Se sucesso:
   *    - Exibe toast de sucesso
   *    - Usu√°rio deve fazer login ap√≥s cadastro
   * 3. Se erro:
   *    - Exibe toast com mensagem de erro
   * 
   * RETORNO:
   * { success: boolean, error?: string }
   */
  const register = async (userData: {
    userType: 'aluno' | 'professor';
    nomeCompleto: string;
    cpf: string;
    genero: string;
    dataNascimento: string;
  }) => {
    console.log('üìù [useAuth] Tentando registrar novo usu√°rio...', {
      tipo: userData.userType,
      nome: userData.nomeCompleto
    });
    
    const cleanedCpf = cleanCpf(userData.cpf);
    if (!cleanedCpf || !/^\d{11}$/.test(cleanedCpf)) {
      console.error('‚ùå [useAuth] CPF inv√°lido:', userData.cpf);
      toast({
        title: "Erro no cadastro",
        description: "O CPF deve conter 11 d√≠gitos num√©ricos (ex.: 12345678901).",
        variant: "destructive",
      });
      return { success: false, error: 'Invalid CPF format' };
    }
    
    try {
      const response = await apiFetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      // Verificar se a resposta √© JSON
      const contentType = response.headers.get('content-type');
      console.log('üìã [useAuth] Content-Type da resposta:', contentType);
      
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('‚ùå [useAuth] API retornou HTML ao inv√©s de JSON:', text.substring(0, 200));
        throw new Error('Erro de comunica√ß√£o com o servidor. A API n√£o est√° respondindo corretamente.');
      }

      const data = await response.json();
      console.log('üì° [useAuth] Resposta do servidor:', response.status);
      
      if (!response.ok) {
        console.error('‚ùå [useAuth] Erro no cadastro:', data.error);
        throw new Error(data.error || 'Erro no cadastro');
      }

      localStorage.setItem('userEmail', data.email);
      console.log('üíæ [useAuth] Email salvo no localStorage:', data.email);
      
      console.log('‚úÖ [useAuth] Cadastro realizado com sucesso!');
      toast({
        title: "Cadastro realizado com sucesso!",
        description: `Email gerado: ${data.email}. Agora voc√™ pode fazer login.`,
      });

      return { success: true };
    } catch (error: any) {
      console.error('‚ùå [useAuth] Erro no cadastro:', error.message);
      toast({
        title: "Erro no cadastro",
        description: error.message || "Erro ao tentar fazer cadastro",
        variant: "destructive",
      });
      return { success: false, error: error.message };
    }
  };

  /**
   * FUN√á√ÉO: Logout de usu√°rio
   * 
   * A√á√ïES REALIZADAS:
   * 1. Remove dados do usu√°rio do localStorage
   * 2. Remove token JWT do localStorage
   * 3. Limpa TODOS os estados persistidos relacionados ao usu√°rio:
   *    - Quest√µes (questions_*)
   *    - Quiz (quizQuestions_*, quizState_*)
   *    - Chat (isChatOpen_*, chattingWith_*, chatMessages_*)
   *    - Professor (students_*, editingQuestion_*)
   *    - V√≠nculo (relations_*, teacherCode_*)
   *    - Coment√°rios (comments_*, newComment_*, responseText_*, respondingTo_*)
   * 4. Atualiza estado local (user = null)
   * 5. Exibe toast de despedida
   * 6. Redireciona para p√°gina inicial (/)
   */
  const logout = () => {
    console.log('üö™ [useAuth] Realizando logout...');
    
    localStorage.removeItem('currentUser');
    localStorage.removeItem('authToken');
    localStorage.removeItem('userEmail');
    console.log('üóëÔ∏è [useAuth] Dados de autentica√ß√£o removidos');
    
    let removedKeys = 0;
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('questions_') || key.startsWith('quizQuestions_') || key.startsWith('isChatOpen_') || key.startsWith('chattingWith_') || key.startsWith('students_') || key.startsWith('relations_') || key.startsWith('teacherCode_') || key.startsWith('comments_') || key.startsWith('editingQuestion_') || key.startsWith('chatMessages_') || key.startsWith('newComment_') || key.startsWith('responseText_') || key.startsWith('respondingTo_') || key.startsWith('quizState_')) {
        localStorage.removeItem(key);
        removedKeys++;
      }
    });
    console.log(`‚úÖ [useAuth] ${removedKeys} chaves removidas do localStorage`);
    
    setUser(null);
    
    toast({
      title: "Logout realizado",
      description: "At√© logo!",
    });
    
    console.log('üîÄ [useAuth] Redirecionando para p√°gina inicial...');
    navigate('/');
  };

  /**
   * FUN√á√ÉO: Obter token JWT de autentica√ß√£o
   * 
   * RETORNO:
   * string | null - Token JWT ou null se n√£o autenticado
   * 
   * USO:
   * Usado para autenticar requisi√ß√µes ao backend
   * Header: Authorization: Bearer {token}
   */
  const getAuthToken = () => {
    const token = localStorage.getItem('authToken');
    console.log('üîë [useAuth] Token solicitado:', token ? 'Token encontrado' : 'Nenhum token');
    return token;
  };

  return {
    user,
    loading,
    login,
    register,
    logout,
    getAuthToken
  };
};